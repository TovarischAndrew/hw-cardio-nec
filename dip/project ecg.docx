2.4 Модуль и его альтернатива.
В ходе исследования выявлено, что схема модуля которая будет высчитывать сердечный ритм, выглядит следующим образом:

 

Рис. Модуль
Однако у данной работы есть альтернативы. Некоторые радиолюбители собирают на Ардуино Нано или АD620A. Ниже приведена схем одного из модулей.

 
Рис.  Альтернатива

А так же уже есть предположительная схема ЭКГ:

 


Рис . Предположительная схема ЭКГ

Что планируется использовать.
Таблица 1 Используемые модули
Обозначение	Тип	Номинал	Кол-во
IC2	MK STM32	STM32F103C8/STM411	1
VR1	Линейный регулятор	AMS1117-3.3	1
MOD1	Модуль 	AD73360AR	2
HG1	TFT LCD	ILI9341	1
Z1	Кварц	8 Мгц	1
HL1	Светодиод		1
EP1	Бузер с генератором	5В	1
S1-S4	Тактовая кнопка		4
С1, С2	Конденсатор 	22пФ	2
С3 – С7, С9	Конденсатор	100нФ	6
С10	Электролит. Конденсатор	100мкФ	1
С8	Электролит конденсатор	220мкФ	1
R1	Резистор	100 ОМ	1
R3-R4	Резистор	10к Ом	3
R5	Резистор	390 Ом	1
МОD2	Модуль ЭКГ	AD8232	1

2.5 Программный код

2.6 Интерфейс SPI
SPI[13] – это последовательный периферийный интерфейс который используется для короткой и дальней связи. Эта связь является синхронно-последовательной. Т.е. представляется связь между ведущего(Мастер) и ведомого(Слейв). А так же можно подключить к мастеру несколько ведомых.
Устройство имеющий SPI может обмениваться данными с помощью двухсторонней связи (Мастер -Слейв). Ведущий(мастер) создает сигнал для чтения и записи. Стоит еще упомянуть о не скольких ведомых. Они могут выбираться при помощи линий SS как видно на рисунке 12. В не которых микросхемах он может называться CS.
 
Рис.  STM и его SPI
 
Рис  SPI
Шины SPI определяется четырьмя логическими сигналами:
•	SCLK: последовательные часы (вывод от мастера)
•	MOSI: Master Out Slave In (вывод данных от мастера)
•	MISO: Master In Slave Out (вывод данных из ведомого)
•	SS: выбор ведомого (часто активный низкий уровень, выход от ведущего)
MOSI на ведущем устройстве подключается к MOSI на ведомом устройстве. MISO на ведущем устройстве подключается к MISO на ведомом устройстве. Если выберем ведомого, который имеет те же функции, что и на микросхеме, то мы можем использовать его вместо концепции адресации.
На ведомом устройстве MOSI может быть обозначен как SDI - последовательный ввод данных, а MISO может быть обозначен как SDO - последовательный вывод данных.
Приведенные выше названия сигналов можно использовать для маркировки выводов как ведущего, так и ведомого устройства, а также сигнальных линий между ними. Имена контактов всегда пишутся с заглавной буквы.
У более старых продуктов могут быть нестандартные имена контактов SPI:
Сигнал тактирования:
•	SCK
Главный выход → ведомый вход (MOSI):
•	SIMO, MTSR - соответствуют MOSI как на ведущем, так и на ведомом устройстве, подключаются друг к другу
•	SDI, DI, DIN, SI - на ведомых устройствах; подключается к MOSI на ведущему устройству
•	SDO, DO, DOUT, SO - на ведущих устройствах; подключается к MOSI на ведомом устройстве
Главный вход ← Ведомый выход (MISO):
•	SOMI, MRST - соответствуют MISO как на ведущем, так и на ведомом устройстве, подключаются друг к другу
•	SDO, DO, DOUT, SO - на ведомых устройствах; подключается к MISO на ведущем устройстве
•	SDI, DI, DIN, SI - на ведущих устройствах; подключается к MISO на ведомом устройстве
Выбор ведомого:
•	SS, SS, SSEL, nSS, / SS, SS # (выбор ведомого)
•	CS, CS (выбор микросхемы)
•	CSN (выбор / включение чипа)
•	CE (включение чипа)

Операции, которые может использовать SPI
Шина SPI может работать как с одним ведущим устройством, так и с одним или несколькими ведомыми устройствами как упоминалась ранее.
Если используется одно ведомое устройство, на выводе SS может быть зафиксирован низкий логический уровень т.е. состояние 0. Некоторым ведомым требуется задний фронтовой сигнал микросхемы, чтобы начать действие.
Большинство ведомых устройств имеют выходы с тремя состояниями, поэтому их сигнал MISO становится отключенным, когда устройство не выбрано. Устройства без выходов с тремя состояниями не могут совместно использовать сегменты шины SPI с другими устройствами без использования внешнего буфера с тремя состояниями.
Передача данных в SPI
Чтобы начать обмен данными, ведущий настраивает часы, используя частоту, поддерживаемую ведомым устройством, обычно до нескольких МГц. Затем ведущий выбирает ведомое устройство с логическим уровнем 0 в строке выбора. Если требуется период ожидания, например, для аналого-цифрового преобразования, то ведущее устройство должно выждать, по крайней мере, период времени, прежде чем выдавать тактовые циклы.
Во время каждого тактового цикла SPI происходит двунаправленная передача данных. Ведущее устройство отправляет бит в строке MOSI, ведомое устройство читает его, в то время как ведомое устройство отправляет бит в строке MISO, а ведущее устройство читает его. Данная последовательность сохраняется даже тогда, когда есть только однонаправленная передача данных.
Передача обычно включает два регистра сдвига некоторого заданного размера слова, например, восемь бит, один в ведущем и один в ведомом; они соединены в кольца. Данные сдвигаются сначала со старшим битом. На фронте тактового сигнала и ведущий, и ведомый немного сдвигаются и выводят его по линии передачи на противоположную часть. На следующем фронте тактового сигнала в каждом приемнике бит выбирается из линии передачи и устанавливается как новый младший бит сдвигового регистра. После того, как биты регистра были сдвинуты внутрь и обратно, ведущее и ведомое устройства обменялись значениями регистров. Если необходимо обменять больше данных, регистры сдвига перезагружаются, и процесс повторяется. Передача может продолжаться в течение любого количества тактов. По завершении SPI мастер(ведомый) перестает переключать тактовый сигнал.
Передачи часто состоят из восьми битных слов. Другие размеры слова также можно передать, например, шестнадцати битные слова для контроллеров сенсорного экрана. Несколько устройств SPI также могут быть подключены последовательно для экономии контактов.
Каждое ведомое устройство на шине, которое не было активировано с помощью своей линии микросхемы, должно игнорироваться входными тактовыми сигналами, а сигналы MOSI и не должны управлять MISO т.е., оно должно иметь выход с тремя состояниями, с некоторым устройствам для реализации этого требуются внешние буферы с тремя состояниями.

 
Рис 12 Пример подключения



Проектирование

3.1 Выбор аппаратуры при проектировке схемы
Для оцифровки у модуля должно быть 12 отведений, и частота будет составлять 1000гц, а также нужно стабильное питание.
Рассмотрим не которые модули. 
AD8232 - хитроумное сплетение операционников, снимающее по факту всего одно отведение. Он может управлять еще и другими отведениями. По одному операционнику на канал. Если использовать модуль ADS, то уже можно 9 отведении сделать.
Orange Pi [9] добавляем как сервер, + делаем так же 12 отведений, если запитывать от USB [10] надо гальванически развязывать питание.
Есть еще одна операционнка, 8-ми канальный АЦП sigma-delta 16 бит с последовательным портом 30 ksps ADS1256IDBT. Имеет 24 бита по 8 портов, 18,6 бит без шума на канал 2,5 ksps, что в два раза больше чем нам надо.

AD73360AR - 6 одновременных каналов s-d-ADC. У них каскадное подключение есть по протоколу SPI, что удобно. И будем использовать 2 таких модуля и подключим их с помощью протокола SPI.
Возьмем STM32F411 или STM32F103C8.
Входные цепи аппарата ЭКГ должны усиливать довольно слабый сигнал — в диапазоне напряжений 0,5–5 мВ в сочетании с постоянной составляющей величиной до ±300 мВ, которая возникает при контакте электрода с кожей (в русскоязычной литературе это явление называется кожно-гальванической реакцией[11], КГР. — Прим. перев.), плюс синфазная составляющая величиной до 1,5 В между электродами и общим (земляным) проводом. Полоса частот, подлежащая обработке и анализу, составляет, в зависимости от вида исследования, от 0,5 Гц до 50 Гц (в устройствах мониторинга при интенсивной терапии), и до 1 кГц при исследовании[12] водителей сердечного ритма (пейсмейкеров). Стандартный клинический аппарат ЭКГ работает с полосой частот 0,05–100 Гц.
500 мкВ входной сигнал. Важнее минимизировать напряжение смещения.
opa2350 - 150 uV -> 500mV - не пойдет.
AD824 - 100uV -> 1000 uV - лучше (2pA по току смещение)
AD620A - 50uV (ok), 1000 pA смещение, на нем любители делают кардиографы.
опорный - opa2335 - 60 uV/1pA.
И все же в данном случае берем AD620A.
ILI9341 будет экраном.
AD73360ARZSOP28-АЦП.
ADR02ARZ - Генератор опорного напряжения. 
AD620ARZ - Малошумящий операционный усилитель.


3.2. EaseEDA
Более простой и мощный онлайн-инструмент для проектирования печатных плат с использованием деталей и услуг печатных плат, работающих на базе LCSC. EasyEDA-это более простой и мощный онлайн-инструмент для проектирования печатных плат, который позволяет инженерам-электронщикам, преподавателям, студентам, производителям и энтузиастам разрабатывать и делиться своими проектами. Это инструмент проектирования, интегрированный в каталог компонентов LCSC и сервис печатных плат JLCPCB, который помогает пользователям сэкономить время, чтобы воплотить свои идеи в реальные продукты.
Особенности.
Общие возможности рисования такие как: схематический захват, макет печатной платы, работа на любом устройстве, командное сотрудничество в режиме реального времени, совместное использование в интернете, тысячи проектов с открытым исходным кодом, Прямые ссылки на компоненты LCSC для выбора, Интегрированное изготовление печатных плат, Импорт, Altium/Kicad/Eagle, PNG, DXF.
Более 1 Миллиона Бесплатных Библиотек API.

 
4.3. Схема

 
Рис Схема спроектирована
 
